# í”„ë¡ íŠ¸ì—”ë“œ CI/CD + deployment ì›Œí¬í”Œë¡œìš°
# main ë¸Œëœì¹˜ì— ì§ì ‘ pushë˜ê±°ë‚˜ PRì´ mergeë˜ëŠ” ê²½ìš°ì— ì‹¤í–‰ë˜ì–´ ë¹Œë“œ, í…ŒìŠ¤íŠ¸ í›„ artifactsë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
# Discord ì•Œë¦¼: Repository Secretì— DISCORD_WEBHOOK_URL ì„¤ì • ì‹œ ì„±ê³µ/ì‹¤íŒ¨ ì•Œë¦¼ ì „ì†¡ (docs/DISCORD_NOTIFICATION.md ì°¸ê³ )
name: Frontend CI/CD

on:
  push:               # main ë˜ëŠ” dev ë¸Œëœì¹˜ì— ì§ì ‘ pushë  ë•Œ ì‹¤í–‰
    branches:
      - main
      - dev      
  pull_request:       # main ë¸Œëœì¹˜ë¡œì˜ PRì´ ìƒì„±ë˜ê±°ë‚˜ ì—…ë°ì´íŠ¸ë  ë•Œ ì‹¤í–‰
    branches:
      - main

# OIDCë¥¼ í†µí•œ AWS ì¸ì¦ì„ ìœ„í•œ ê¶Œí•œ ì„¤ì •
permissions:
  id-token: write   # OIDC í† í° ë°œê¸‰ ê¶Œí•œ
  contents: read    # ë¦¬í¬ì§€í† ë¦¬ ì½ê¸° ê¶Œí•œ

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      # 2. Node.js í™˜ê²½ ì„¤ì •
      - name: Node.js í™˜ê²½ ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # 3. ì˜ì¡´ì„± ì„¤ì¹˜ (npm ciëŠ” package-lock.jsonì„ ê¸°ë°˜ìœ¼ë¡œ ì •í™•í•œ ë²„ì „ ì„¤ì¹˜)
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
      
      # 4. ì½”ë“œ ë¦°íŠ¸ ê²€ì‚¬ (ì½”ë“œ ìŠ¤íƒ€ì¼ ë° ì ì¬ì  ì˜¤ë¥˜ í™•ì¸)
      - name: ë¦°íŠ¸ ê²€ì‚¬ ì‹¤í–‰
        run: npm run lint
      
      # 5. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm test
        # í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ì„ ê²½ìš°ì—ë„ ì›Œí¬í”Œë¡œìš°ê°€ ì¤‘ë‹¨ë˜ì§€ ì•Šë„ë¡ ì„¤ì •
        continue-on-error: true

      # 5-1. ë¸Œëœì¹˜ë³„ API Base URL ì„¤ì • (dev â†’ dev.q-feed.com, main â†’ q-feed.com)
      - name: API Base URL ì„¤ì •
        id: api-url
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "url=https://q-feed.com" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/dev" ]; then
            echo "url=https://dev.q-feed.com" >> $GITHUB_OUTPUT
          else
            echo "url=https://q-feed.com" >> $GITHUB_OUTPUT
          fi
      
      # 6. í”„ë¡œì íŠ¸ ë¹Œë“œ (dist ë””ë ‰í† ë¦¬ ìƒì„±)
      - name: í”„ë¡œì íŠ¸ ë¹Œë“œ
        env:
          VITE_API_BASE_URL: ${{ steps.api-url.outputs.url }}
          VITE_SHOW_REAL_INTERVIEW: false
          VITE_SHOW_PORTFOLIO_INTERVIEW: false
          VITE_SHOW_NOTIFICATIONS: false
        run: npm run build
      
      # 7. package.jsonì—ì„œ ë²„ì „ ì •ë³´ ì¶”ì¶œ
      - name: íŒ¨í‚¤ì§€ ë²„ì „ ì¶”ì¶œ
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      # 8. ë¹Œë“œëœ dist ë””ë ‰í† ë¦¬ë¥¼ tar.gz í˜•ì‹ìœ¼ë¡œ ì••ì¶•
      # íŒŒì¼ëª… í˜•ì‹: fe-{version}.tar.gz (ì˜ˆ: fe-v0.0.0.tar.gz)
      - name: ë¹Œë“œ ê²°ê³¼ë¬¼ ì••ì¶•
        run: tar -czf fe-v${{ steps.package-version.outputs.version }}.tar.gz dist/
      
      # 9. ì••ì¶•ëœ íŒŒì¼ì„ GitHub Artifactsì— ì—…ë¡œë“œ
      - name: ë¹Œë“œ ì‚°ì¶œë¬¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          # artifact ì´ë¦„ì— ë²„ì „ í¬í•¨ (ì˜ˆ: fe-build-v0.0.0)
          name: fe-v${{ steps.package-version.outputs.version }}
          # ì—…ë¡œë“œí•  íŒŒì¼ ê²½ë¡œ
          path: fe-v${{ steps.package-version.outputs.version }}.tar.gz
          # 90ì¼ ë™ì•ˆ ë³´ê´€ í›„ ìë™ ì‚­ì œ
          retention-days: 90
          # ì´ë¯¸ tar.gzë¡œ ì••ì¶•ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì¶”ê°€ ì••ì¶• ë¶ˆí•„ìš”
          compression-level: 0

      # ì„œë²„ ì—…ë¡œë“œê¹Œì§€ ì™„ë£Œ ì‹œ CI í†µê³¼ ì•Œë¦¼ (Discord)
      - name: Discord ì•Œë¦¼ (CI í†µê³¼)
        if: success()
        continue-on-error: true
        run: |
          curl -sS -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âœ… FE CI í†µê³¼",
                "description": "ë¹Œë“œÂ·í…ŒìŠ¤íŠ¸Â·ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ ë° **ì„œë²„ íŒŒì¼ ì—…ë¡œë“œ**ê¹Œì§€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
                "color": 3066993,
                "fields": [
                  {"name": "ë¸Œëœì¹˜", "value": "'"${{ github.ref_name }}"'", "inline": true},
                  {"name": "ì»¤ë°‹", "value": "`'"${{ github.sha }}"'`", "inline": true},
                  {"name": "íŠ¸ë¦¬ê±°", "value": "'"${{ github.event_name }}"'", "inline": true}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
            }'
            
  deploy-prod:
    name: Deploy to Production (S3)
    runs-on: ubuntu-latest
    needs: build-and-test

    # main ë¸Œëœì¹˜ë¡œ pushëœ ê²½ìš°ì—ë§Œ ë°°í¬ ì‹¤í–‰
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: íŒ¨í‚¤ì§€ ë²„ì „ ì¶”ì¶œ
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: ë¹Œë“œ ì‚°ì¶œë¬¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: fe-v${{ steps.package-version.outputs.version }}

      # tar.gz ì••ì¶• í•´ì œí•˜ì—¬ dist í´ë” ì¶”ì¶œ
      - name: ì••ì¶• í•´ì œ
        run: |
          tar -xzf fe-v${{ steps.package-version.outputs.version }}.tar.gz

      # AWS ìê²©ì¦ëª… ì„¤ì • (OIDC ë°©ì‹)
      - name: AWS ìê²©ì¦ëª… ì„¤ì • (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-2

      # S3 ë²„í‚·ì— íŒŒì¼ ì—…ë¡œë“œ (ê¸°ì¡´ íŒŒì¼ ì‚­ì œ í›„ ìƒˆë¡œ ì—…ë¡œë“œ)
      - name: S3ì— ë°°í¬
        run: |
          # ê¸°ì¡´ íŒŒì¼ ì‚­ì œ
          aws s3 rm s3://qfeed-prod-s3-frontend --recursive
          # ìƒˆ íŒŒì¼ ì—…ë¡œë“œ (dist í´ë”ì˜ ë‚´ìš©ì„ ë²„í‚· ë£¨íŠ¸ì— ì—…ë¡œë“œ)
          aws s3 cp dist/ s3://qfeed-prod-s3-frontend --recursive

      # CloudFront ìºì‹œ ë¬´íš¨í™”
      - name: CloudFront ìºì‹œ ë¬´íš¨í™” (Prod)
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_PROD }} \
            --paths "/*"

      # Prod ë°°í¬ ì„±ê³µ ì•Œë¦¼
      - name: Discord ì•Œë¦¼ (Prod ë°°í¬ ì„±ê³µ)
        if: success()
        continue-on-error: true
        run: |
          curl -sS -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "ğŸš€ FE ë°°í¬ ì„±ê³µ (Production)",
                "description": "S3 ë²„í‚·ì— í”„ë¡ íŠ¸ì—”ë“œê°€ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.",
                "color": 5763719,
                "fields": [
                  {"name": "í™˜ê²½", "value": "**PROD**", "inline": true},
                  {"name": "ë²„í‚·", "value": "`qfeed-prod-s3-frontend`", "inline": true},
                  {"name": "ë¸Œëœì¹˜", "value": "'"${{ github.ref_name }}"'", "inline": true},
                  {"name": "ì»¤ë°‹", "value": "`'"${{ github.sha }}"'`", "inline": false}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
            }'

  deploy-dev:
    name: Deploy to Dev (S3)
    runs-on: ubuntu-latest
    needs: build-and-test

    # dev ë¸Œëœì¹˜ë¡œ pushëœ ê²½ìš°ì—ë§Œ ë°°í¬ ì‹¤í–‰
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: íŒ¨í‚¤ì§€ ë²„ì „ ì¶”ì¶œ
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: ë¹Œë“œ ì‚°ì¶œë¬¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: fe-v${{ steps.package-version.outputs.version }}

      # tar.gz ì••ì¶• í•´ì œí•˜ì—¬ dist í´ë” ì¶”ì¶œ
      - name: ì••ì¶• í•´ì œ
        run: |
          tar -xzf fe-v${{ steps.package-version.outputs.version }}.tar.gz

      # AWS ìê²©ì¦ëª… ì„¤ì • (OIDC ë°©ì‹)
      - name: AWS ìê²©ì¦ëª… ì„¤ì • (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-2

      # S3 ë²„í‚·ì— íŒŒì¼ ì—…ë¡œë“œ (ê¸°ì¡´ íŒŒì¼ ì‚­ì œ í›„ ìƒˆë¡œ ì—…ë¡œë“œ)
      - name: S3ì— ë°°í¬
        run: |
          # ê¸°ì¡´ íŒŒì¼ ì‚­ì œ
          aws s3 rm s3://qfeed-dev-s3-static --recursive
          # ìƒˆ íŒŒì¼ ì—…ë¡œë“œ (dist í´ë”ì˜ ë‚´ìš©ì„ ë²„í‚· ë£¨íŠ¸ì— ì—…ë¡œë“œ)
          aws s3 cp dist/ s3://qfeed-dev-s3-static --recursive

      # CloudFront ìºì‹œ ë¬´íš¨í™”
      - name: CloudFront ìºì‹œ ë¬´íš¨í™” (Dev)
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_DEV }} \
            --paths "/*"

      # Dev ë°°í¬ ì„±ê³µ ì•Œë¦¼
      - name: Discord ì•Œë¦¼ (Dev ë°°í¬ ì„±ê³µ)
        if: success()
        continue-on-error: true
        run: |
          curl -sS -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "ğŸš€ FE ë°°í¬ ì„±ê³µ (Dev)",
                "description": "S3 ë²„í‚·ì— í”„ë¡ íŠ¸ì—”ë“œê°€ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.",
                "color": 3447003,
                "fields": [
                  {"name": "í™˜ê²½", "value": "**DEV**", "inline": true},
                  {"name": "ë²„í‚·", "value": "`qfeed-dev-s3-static`", "inline": true},
                  {"name": "ë¸Œëœì¹˜", "value": "'"${{ github.ref_name }}"'", "inline": true},
                  {"name": "ì»¤ë°‹", "value": "`'"${{ github.sha }}"'`", "inline": false}
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
            }'

  deploy-dev:
    name: Deploy to Dev (EC2)
    runs-on: ubuntu-latest
    needs: build-and-test

    # dev ë¸Œëœì¹˜ë¡œ pushëœ ê²½ìš°ì—ë§Œ ë°°í¬ ì‹¤í–‰
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: íŒ¨í‚¤ì§€ ë²„ì „ ì¶”ì¶œ
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: ë¹Œë“œ ì‚°ì¶œë¬¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: fe-v${{ steps.package-version.outputs.version }}

      # ì„œë²„ë¡œ ì‚°ì¶œë¬¼ì„ ì „ì†¡í•œ ë’¤, ì„œë²„ ë‚´ë¶€ deploy.shë¡œ êµì²´/ë°±ì—… ì²˜ë¦¬
      - name: SSH í‚¤ ì„¤ì •
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.QFEED_EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.QFEED_EC2_DEV_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            -o ServerAliveInterval=10 \
            ${{ secrets.QFEED_EC2_USER }}@${{ secrets.QFEED_EC2_DEV_HOST }} \
            "echo 'Connection successful'"

      - name: ì„œë²„ë¡œ íŒŒì¼ ì—…ë¡œë“œ (SCP)
        timeout-minutes: 5
        run: |
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=60 \
            -o ServerAliveInterval=10 \
            -o ServerAliveCountMax=3 \
            fe-v${{ steps.package-version.outputs.version }}.tar.gz \
            ${{ secrets.QFEED_EC2_USER }}@${{ secrets.QFEED_EC2_DEV_HOST }}:/tmp/

      - name: ì„œë²„ì—ì„œ ë°°í¬ ì‹¤í–‰ (deploy-fe.sh)
        timeout-minutes: 5
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.QFEED_EC2_DEV_HOST }}
          username: ${{ secrets.QFEED_EC2_USER }}
          key: ${{ secrets.QFEED_EC2_SSH_KEY }}
          timeout: 60s
          command_timeout: 5m
          script: |
            set -e
            sudo /srv/qfeed/deploy-fe.sh /tmp/fe-v${{ steps.package-version.outputs.version }}.tar.gz

  # CI ì‹¤íŒ¨ ì‹œ ì–´ë–¤ ê³¼ì •ì—ì„œ ì‹¤íŒ¨í–ˆëŠ”ì§€ Discord ì•Œë¦¼
  discord-notify-failure:
    name: Discord ì•Œë¦¼ (ì‹¤íŒ¨ ìƒì„¸)
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy-prod, deploy-dev]
    if: always() && (needs.build-and-test.result == 'failure' || needs.deploy-prod.result == 'failure' || needs.deploy-dev.result == 'failure')
    steps:
      - name: ì‹¤íŒ¨í•œ Job/Step ì¡°íšŒ
        id: failed
        run: |
          RES=$(curl -sS -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs")
          FAILED_JOB=$(echo "$RES" | jq -r '.jobs[] | select(.conclusion == "failure") | .name' | head -1)
          FAILED_JOB_ID=$(echo "$RES" | jq -r '.jobs[] | select(.conclusion == "failure") | .id' | head -1)
          if [ -n "$FAILED_JOB_ID" ]; then
            STEPS_RES=$(curl -sS -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/jobs/$FAILED_JOB_ID")
            FAILED_STEP=$(echo "$STEPS_RES" | jq -r '.steps[] | select(.conclusion == "failure") | .name' | head -1)
          else
            FAILED_STEP="(í™•ì¸ ë¶ˆê°€)"
          fi
          [ -z "$FAILED_JOB" ] && FAILED_JOB="(ì•Œ ìˆ˜ ì—†ìŒ)"
          [ -z "$FAILED_STEP" ] && FAILED_STEP="(ì•Œ ìˆ˜ ì—†ìŒ)"

          # ì–´ë–¤ job(ë‹¨ê³„)ì—ì„œ ì‹¤íŒ¨í–ˆëŠ”ì§€ì— ë”°ë¼ Discord ë©”ì‹œì§€ ë‚´ìš©ì„ ë‹¤ë¥´ê²Œ êµ¬ì„±
          STAGE="unknown"
          TITLE="âŒ FE ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨"
          TARGET="(ì•Œ ìˆ˜ ì—†ìŒ)"

          if [ "${{ needs.build-and-test.result }}" = "failure" ]; then
            STAGE="build-and-test"
            TITLE="âŒ FE CI ì‹¤íŒ¨ (ë¹Œë“œ/í…ŒìŠ¤íŠ¸)"
            TARGET="CI"
          elif [ "${{ needs.deploy-prod.result }}" = "failure" ]; then
            STAGE="deploy-prod"
            TITLE="âŒ FE ë°°í¬ ì‹¤íŒ¨ (Production)"
            TARGET="PROD (S3: qfeed-prod-s3-frontend)"
          elif [ "${{ needs.deploy-dev.result }}" = "failure" ]; then
            STAGE="deploy-dev"
            TITLE="âŒ FE ë°°í¬ ì‹¤íŒ¨ (Dev)"
            TARGET="DEV (S3: qfeed-dev-s3-static)"
          fi

          # ì‹¤íŒ¨ Step ê¸°ë°˜ìœ¼ë¡œ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•œ ì ê²€ ê°€ì´ë“œ ìƒì„±
          GUIDE="Actions ë¡œê·¸ì—ì„œ ì—ëŸ¬ ìŠ¤íƒ/ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”."
          case "$FAILED_STEP" in
            "ì˜ì¡´ì„± ì„¤ì¹˜"*)
              GUIDE=$'ì˜ì¡´ì„± ì„¤ì¹˜ ì‹¤íŒ¨\n- package-lock.json ì¶©ëŒ/ì†ìƒ ì—¬ë¶€ í™•ì¸\n- ë¡œì»¬ì—ì„œ: npm ci\n- Node ë²„ì „(20)ê³¼ íŒ¨í‚¤ì§€ í˜¸í™˜ì„± í™•ì¸'
              ;;
            "ë¦°íŠ¸ ê²€ì‚¬ ì‹¤í–‰"*)
              GUIDE=$'ë¦°íŠ¸ ì‹¤íŒ¨\n- ë¡œì»¬ì—ì„œ: npm run lint\n- ì‹¤íŒ¨ íŒŒì¼/ê·œì¹™ í™•ì¸ í›„ ìˆ˜ì •'
              ;;
            "í…ŒìŠ¤íŠ¸ ì‹¤í–‰"*)
              GUIDE=$'í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨\n- ë¡œì»¬ì—ì„œ: npm test\n- í…ŒìŠ¤íŠ¸ê°€ flakyë©´ ì›ì¸(ë„¤íŠ¸ì›Œí¬/íƒ€ì„ì•„ì›ƒ/í™˜ê²½ ë³€ìˆ˜) í™•ì¸'
              ;;
            "í”„ë¡œì íŠ¸ ë¹Œë“œ"*)
              GUIDE=$'ë¹Œë“œ ì‹¤íŒ¨\n- ë¡œì»¬ì—ì„œ: npm run build\n- VITE_* í™˜ê²½ ë³€ìˆ˜ ì£¼ì…/ê°’ í™•ì¸\n- (dev/main ë¶„ê¸°) VITE_API_BASE_URL ê°’ì´ ê¸°ëŒ€ì™€ ê°™ì€ì§€ í™•ì¸'
              ;;
            "SSH í‚¤ ì„¤ì •"*)
              GUIDE=$'SSH í‚¤ ì„¤ì • ì‹¤íŒ¨\n- secrets.QFEED_EC2_SSH_KEY ê°’ì´ PEM í˜•ì‹ì¸ì§€ í™•ì¸\n- ì¤„ë°”ê¿ˆ í¬í•¨ ì—¬ë¶€/ê¶Œí•œ(chmod 600) í™•ì¸'
              ;;
            "ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸"*)
              GUIDE=$'ì„œë²„ ì—°ê²° ì‹¤íŒ¨\n- ëŒ€ìƒ ì„œë²„ì—ì„œ 22ë²ˆ í¬íŠ¸/ë³´ì•ˆê·¸ë£¹ í—ˆìš© í™•ì¸\n- host/user ì‹œí¬ë¦¿ ê°’ í™•ì¸ (ê°’ ìì²´ëŠ” ë…¸ì¶œ ê¸ˆì§€)\n- ì„œë²„ê°€ ì‚´ì•„ìˆëŠ”ì§€(Ping/EC2 ìƒíƒœ) í™•ì¸'
              ;;
            "ì„œë²„ë¡œ íŒŒì¼ ì—…ë¡œë“œ (SCP)"*)
              GUIDE=$'SCP ì—…ë¡œë“œ ì‹¤íŒ¨\n- /tmp ë””ìŠ¤í¬ ìš©ëŸ‰/ê¶Œí•œ í™•ì¸\n- ë„¤íŠ¸ì›Œí¬/ë³´ì•ˆê·¸ë£¹/SSH ì—°ê²° ì•ˆì •ì„± í™•ì¸'
              ;;
            "ì„œë²„ì—ì„œ ë°°í¬ ì‹¤í–‰ (deploy-fe.sh)"*)
              GUIDE=$'ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨\n- ì„œë²„ì— /srv/qfeed/deploy-fe.sh ì¡´ì¬/ì‹¤í–‰ê¶Œí•œ í™•ì¸\n- sudo ê¶Œí•œ ë° ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€ ë¡œê·¸ í™•ì¸\n- tar.gz ê²½ë¡œ(/tmp/fe-vX.Y.Z.tar.gz) í™•ì¸'
              ;;
          esac

          echo "job=$FAILED_JOB" >> $GITHUB_OUTPUT
          echo "step=$FAILED_STEP" >> $GITHUB_OUTPUT
          echo "stage=$STAGE" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "target=$TARGET" >> $GITHUB_OUTPUT
          # multiline ì§€ì›ì„ ìœ„í•´ heredoc í˜•íƒœë¡œ output ì‘ì„±
          {
            echo "guide<<'EOF'"
            echo "$GUIDE"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Discord ì•Œë¦¼ (ì‹¤íŒ¨ ìƒì„¸)
        continue-on-error: true
        run: |
          PAYLOAD=$(jq -n \
            --arg job "${{ steps.failed.outputs.job }}" \
            --arg step "${{ steps.failed.outputs.step }}" \
            --arg stage "${{ steps.failed.outputs.stage }}" \
            --arg title "${{ steps.failed.outputs.title }}" \
            --arg target "${{ steps.failed.outputs.target }}" \
            --arg guide "${{ steps.failed.outputs.guide }}" \
            --arg ref "${{ github.ref_name }}" \
            --arg sha "${{ github.sha }}" \
            --arg url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --arg ts "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            '{
              embeds: [{
                title: $title,
                description: (
                  "**ëŒ€ìƒ:** " + $target + "\n"
                  + "**ì‹¤íŒ¨í•œ Job:** " + $job + "\n"
                  + "**ì‹¤íŒ¨í•œ Step:** " + $step + "\n\n"
                  + "**ì ê²€ ê°€ì´ë“œ**\n" + $guide + "\n\n"
                  + "_ìƒì„¸ ë¡œê·¸ëŠ” Run ë³´ê¸° ë§í¬ì—ì„œ í™•ì¸í•˜ì„¸ìš”._"
                ),
                color: 15158332,
                fields: [
                  {name: "ë¸Œëœì¹˜", value: $ref, inline: true},
                  {name: "ì»¤ë°‹", value: ("`" + $sha + "`"), inline: true},
                  {name: "Stage", value: $stage, inline: true},
                  {name: "ì›Œí¬í”Œë¡œìš°", value: ("[Run ë³´ê¸°](" + $url + ")"), inline: false}
                ],
                timestamp: $ts
              }]
            }')
          curl -sS -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
